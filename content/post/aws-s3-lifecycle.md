+++
draft = true
thumbnail="images/AWS-Lifecycle.png"
toc= true
tags = ["AWS", "S3"]
categories = ["AWS"]
date = "2019-03-21T12:34:59+09:00"
lastmod = "2020-01-06T12:40:49+09:00"
title = "S3の機能、ライフサイクルルールの使い方"
description = "S3で一定期間たったらファイルを削除、ストレージクラスを下げて低コスト化などをできるライフサイクルルールの使い方について解説。"
+++
## 大量に発生する通信ログにうんざりですか？
S3の機能の一つ**ライフサイクルルール**を使いましょう！！

### ライフサイクルとは
こういう系は言葉の意味を理解するのが地味に重要な気がしてるから載せる

>ライフサイクル（英: life cycle）は、人生の経過を円環に描いて説明したもの。精神分析家で発達心理学者のエリク・H・エリクソンが、その著『ライフサイクル　その完結』で取り上げてから、この言葉が浸透するようになった。近代の始めあたりまで、洋の東西を問わず、人の一生を図解で説明するのに使われるのは、太鼓橋、もしくは階段状の乗降台のようなスタイルだった。これで、人生前半の成長と、後半の老化を説明したものである。それは、今で言うライフスパンにあたる。 
>ー [Wikipedia](https://ja.wikipedia.org/wiki/%E3%83%A9%E3%82%A4%E3%83%95%E3%82%B5%E3%82%A4%E3%82%AF%E3%83%AB)

**生き様**みたいな意味ですかね？

簡単に言うと、この機能はファイルに寿命を与える機能です。 **寿命を過ぎると削除もしくは移動をすることができます。** そうすることによって"無駄にファイル(今回はアクセスログ)が溜まって料金を請求される。"なんてことが無くなります。

{{% adsense %}}
## オブジェクトに寿命を与える。
一番簡単な奴です。

### この画面まで来る

{{< img src="images/aws-s3-lifecycle-s3.png" caption="ここ" >}}

### そしておもむろに"管理"タブをクリック
{{< img src="images/aws-s3-lifecycle-managementroom.png" caption="こんな感じ" >}}

### ライフサイクルルールを追加を押してごにょごにょ。

{{< img src="images/aws-s3-lifecycle-control.png" caption="こんな感じ" >}}

**ルール名**:ルールの名前です。10年後でも機能が理解できる名前なら何でもいいです


**フィルターを追加してプレフィックス/タグのみを対象にする**:特定のファイルの下だけにライフサイクルルールを適用させたい時に使う。
    
入力例:
```
すごいフォルダ/
```
これを入力するだけで```すごいフォルダ/```より下の方がライフサイクルの設定の適用範囲となります。

こっちは今回は使いません。

### 無視する。
**無視する。**
{{< img src="images/aws-s3-lifecycle-control2.png" caption="**無視**" >}}
([次の奴で](https://www.saltandsugar.tech/post/aws-s3-lifecycle/#%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AB%E7%94%9F%E3%81%8D%E6%A7%98%E3%82%92%E4%B8%8E%E3%81%88%E3%82%8B)使う)

### 設定する！

**ここ重要！！**

とりあえず下の画像な感じにしましょう、後で解説します。

{{< img src="images/aws-s3-lifecycle-control3.png" caption="こんな感じにしとけばいい" >}}

### 解説:

 **現行バージョン・前のバージョン**:そのまんま。今あるものが現行バージョン。昔作ってたけど今のバージョンに上書きされてしまったのが前のバージョン。(まぁS3とかCloudfrontのログは上書きせずそのまんま突っ込んでくるんで関係ないです。一応両方オン。両方同じ。)

余談:なんか[AWSのドキュメント](https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/user-guide/create-lifecycle.html)には不完全なマルチパートクリーンアップする"が推奨されてるっぽいです。AWSのドキュメントってわかりにくいよな(僕だけ?)

### 確認！！！！！

**下手なことしたらデータ消えます**

そしたら「保存」で前半終わり。

{{< adsense >}}
## オブジェクトに生き様を与える。
**お兄さん**->**お爺さん**

の様に

**標準ストレージ**(結構アクセスしたりする物用)→**低頻度アクセスストレージ** (あんまりアクセスしない物用、価格が安い) →削除

みたいな感じにします。


### 編集画面まで戻る

{{< img src="images/aws-s3-lifecycle-control4.png" caption="ここね" >}}
もちろんボックス**両方オン**。

で、両方の**以降を追加**をクリック

{{< img src="images/aws-s3-lifecycle-control6.png" caption="こんな感じ" >}}

で、**以降を選択する**の中に選択肢が四つありますね。下に行けば保管コストは安くなります。その代わり諸々の制約があるので注意(ログを掘り返すなんてなかなか無いから一番したのでええやろ)

{{< img src="images/aws-s3-lifecycle-control7.png" caption="こんな感じ" >}}
低頻度アクセスより下からGB単位で取り出し料がかかるのは注意です。

{{< img src="images/aws-s3-lifecycle-control8.png" caption="完成形" >}}

その後はまた[ここ](https://saltandsugar.tech/post/aws-s3-lifecycle/#5-%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B)まで戻って、オブジェクトが移行された後何日で消去するか？を設定してやって下さい。

